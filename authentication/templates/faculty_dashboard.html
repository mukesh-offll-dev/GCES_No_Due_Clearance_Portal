{% extends "base.html" %}
{% block title %}Faculty Advisor{% endblock %}

{% block content %}

<main class="max-w-6xl mx-auto p-6">

<!-- FILTER -->
<form method="GET"
  class="flex gap-6 border-2 border-[#d52b1e] p-6 rounded-3xl mb-6 items-center">

  <select name="branch" onchange="this.form.submit()"
    class="border rounded-full px-4 py-2 w-40">
    <option value="">Select Branch</option>
    <option value="CSE" {% if branch == "CSE" %}selected{% endif %}>CSE</option>
    <option value="ECE" {% if branch == "ECE" %}selected{% endif %}>ECE</option>
    <option value="EEE" {% if branch == "EEE" %}selected{% endif %}>EEE</option>
    <option value="CIVIL" {% if branch == "CIVIL" %}selected{% endif %}>CIVIL</option>
    <option value="MECH" {% if branch == "MECH" %}selected{% endif %}>MECH</option>
    <option value="MCT" {% if branch == "MCT" %}selected{% endif %}>MCT</option>
  </select>

  <select name="year" onchange="this.form.submit()"
    class="border rounded-full px-4 py-2 w-32">
    <option value="">Select Year</option>
    <option value="1" {% if year == "1" %}selected{% endif %}>1</option>
    <option value="2" {% if year == "2" %}selected{% endif %}>2</option>
    <option value="3" {% if year == "3" %}selected{% endif %}>3</option>
    <option value="4" {% if year == "4" %}selected{% endif %}>4</option>
  </select>

  <span class="ml-auto bg-[#d52b1e] text-white px-6 py-2 rounded-full font-semibold">
    Students Count - {{ count }}
  </span>
</form>

{% if add_error %}
<p id="addErrorMsg"
   class="text-red-600 font-semibold text-center mb-4">
  {{ add_error }}
</p>
{% endif %}

{% if add_success %}
<p id="addSuccessMsg"
   class="text-green-600 font-semibold text-center mb-4">
  {{ add_success }}
</p>
{% endif %}

<!-- DELETE FORM (wraps students) -->
<form id="deleteForm" method="POST" action="{% url 'delete_students' %}">
{% csrf_token %}
<input type="hidden" name="branch" value="{{ branch }}">
<input type="hidden" name="year" value="{{ year }}">

<!-- TOP BAR -->
<div class="border-2 border-[#d52b1e] rounded-[40px] p-6 mb-6 flex justify-between items-center">

  <button type="button"
    {% if not branch or not year %}disabled{% endif %}
    onclick="openAddModal()"
    class="flex items-center gap-3 font-semibold
    {% if not branch or not year %}opacity-50 cursor-not-allowed{% endif %}">
    <span class="w-9 h-9 bg-gray-300 rounded-lg flex items-center justify-center text-xl">+</span>
    Add Student
  </button>
<div class="flex flex-col items-end">
  <button type="button"
    onclick="handleDeleteClick()"
    class="bg-[#d52b1e] text-white px-8 py-2 rounded-full font-semibold">
    Delete
  </button>

  <!-- Error message exactly below button -->
  <p id="deleteError"
     class="hidden text-red-600 font-semibold text-sm mt-2">
    Please select at least one student to delete
  </p>
</div>

</div>


<!-- STUDENT LIST -->
{% if branch and year %}
  <div id="studentList">

  {% for s in students %}
 <div class="border-2 border-gray-600 bg-white rounded-[20px] p-6 mb-4 flex justify-between items-center shadow-sm student-card"  data-reg="{{ s.reg_no }}">


    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 text-sm font-medium">
      <div>
        <p><b>Register Number :</b> {{ s.reg_no }}</p>
        <p class="mt-2"><b>Roll no :</b> {{ s.roll_no }}</p>
      </div>
      <div>
        <p><b>Name :</b> {{ s.name }}</p>
        <p class="mt-2"><b>Date of Birth :</b> {{ s.dob }}</p>
      </div>
      <div>
        <p class="mt-2"><b>Semester :</b> {{ s.semester }}</p>
        <p class="mt-2"><b>Year :</b> {{ s.year }}</p>
        <p class="mt-2"><b>Branch :</b> {{ s.branch }}</p>
        <p class="mt-2"><b>Phone Number :</b> {{ s.phone }}</p>
      </div>
    </div>

    
    <div class="flex gap-4 items-center">
          <button type="button"
            onclick="openNoDueModal('{{ s.id }}')"
            class="bg-blue-600 text-white px-4 py-1.5 rounded-full text-sm font-semibold">
            No Due
          </button>
          

      <button type="button"
        onclick="openEditModal(
          '{{ s.id }}',
          '{{ s.roll_no }}',
          '{{ s.reg_no }}',
          '{{ s.name }}',
          '{{ s.dob }}',
          '{{ s.phone }}',
          '{{ s.semester }}',
          '{{ s.year }}'
          
        )"
        class="text-blue-600 font-semibold">
        Edit
      </button>

      <input type="checkbox" name="student_ids"
        value="{{ s.id }}" class="w-6 h-6 border-2">
    </div>
  </div>
  {% empty %}
    <p class="text-center font-semibold">No students found</p>
  {% endfor %}
  </div>

{% else %}
  <p class="text-center font-semibold text-gray-600">
    Please select <b>Branch</b> and <b>Year</b>
  </p>
{% endif %}
</form>

</main>

<!-- ================= ADD MODAL ================= -->
<div id="addModal" class="hidden fixed inset-0 bg-black/50 flex justify-center items-center z-50">
<form method="POST" action="{% url 'add_student' %}"
 class="bg-white border-4 border-[#d52b1e] rounded-[30px] p-6 w-[350px]">
{% csrf_token %}
<h2 class="text-xl font-bold text-center mb-4">Create Student Profile</h2>
<input name="roll_no" class="w-full border rounded-full px-4 py-2 mb-2" placeholder="Roll no">
<input name="reg_no" class="w-full border rounded-full px-4 py-2 mb-2" placeholder="Register no">
<input name="name" class="w-full border rounded-full px-4 py-2 mb-2" placeholder="Name">
<input name="semester"
       type="number"
       min="1"
       max="8"
       required
       class="w-full border rounded-full px-4 py-2 mb-2"
       placeholder="Semester (1 - 8)">
<input name="dob" type="date" class="w-full border rounded-full px-4 py-2 mb-2">
<input name="phone" class="w-full border rounded-full px-4 py-2 mb-3" placeholder="Phone">
<input type="hidden" name="branch" value="{{ branch }}">
<input type="hidden" name="year" value="{{ year }}">
<button class="bg-[#d52b1e] text-white w-full py-2 rounded-full">Submit</button>
<button type="button" onclick="closeAddModal()" class="w-full mt-2">Cancel</button>
</form>
</div>

<!-- ================= EDIT MODAL ================= -->
<div id="editModal" class="hidden fixed inset-0 bg-black/50 flex justify-center items-center z-50">
<form method="POST" action="{% url 'edit_student' %}"
 class="bg-white border-4 border-[#d52b1e] rounded-[24px] p-4 w-[300px]">
{% csrf_token %}

<h2 class="text-lg font-bold text-center mb-3">Edit Student</h2>

<input type="hidden" name="student_id" id="edit_id">
<input type="hidden" name="branch" value="{{ branch }}">

<label class="block text-sm font-semibold mb-1">Roll No</label>
<input id="edit_roll" name="roll_no"
       class="w-full border rounded-full px-3 py-1.5 mb-2 text-sm">

<label class="block text-sm font-semibold mb-1">Register No</label>
<input id="edit_reg" name="reg_no"
       class="w-full border rounded-full px-3 py-1.5 mb-2 text-sm">

<label class="block text-sm font-semibold mb-1">Name</label>
<input id="edit_name" name="name"
       class="w-full border rounded-full px-3 py-1.5 mb-2 text-sm">

<label class="block text-sm font-semibold mb-1">Semester</label>
<input id="edit_sem" name="semester" type="number" min="1" max="8"
       class="w-full border rounded-full px-3 py-1.5 mb-2 text-sm">

<label class="block font-semibold mb-1">Year</label>
      <select id="edit_year" name="year"
              required
              class="w-full border rounded-full px-4 py-2 mb-4">
        <option value="1" {% if student.year == 1 %}selected{% endif %}>1</option>
        <option value="2" {% if student.year == 2 %}selected{% endif %}>2</option>
        <option value="3" {% if student.year == 3 %}selected{% endif %}>3</option>
        <option value="4" {% if student.year == 4 %}selected{% endif %}>4</option>
      </select>

<label class="block text-sm font-semibold mb-1">DOB</label>
<input id="edit_dob" name="dob" type="date"
       class="w-full border rounded-full px-3 py-1.5 mb-2 text-sm">

<label class="block text-sm font-semibold mb-1">Phone</label>
<input id="edit_phone" name="phone"
       class="w-full border rounded-full px-3 py-1.5 mb-3 text-sm">

<button class="bg-[#d52b1e] text-white w-full py-1.5 rounded-full text-sm">
  Update
</button>

<button type="button"
        onclick="closeEditModal()"
        class="w-full mt-1 text-sm text-gray-600">
  Cancel
</button>

</form>
</div>

<!-- ================= DELETE CONFIRM ================= -->
<div id="deleteModal" class="hidden fixed inset-0 bg-black/50 flex justify-center items-center z-50">
<div class="bg-white p-6 rounded-2xl text-center w-80">
<h2 class="text-xl font-bold mb-4">Confirm Delete</h2>
<p class="mb-6">Delete selected students?</p>
<div class="flex gap-4 justify-center">
<button onclick="submitDelete()" class="bg-red-600 text-white px-6 py-2 rounded-full">Yes</button>
<button onclick="closeDeleteConfirm()" class="border px-6 py-2 rounded-full">Cancel</button>
</div>
</div>
</div>




<!-- ================= NO DUE MODAL ================= -->
<div id="noDueModal"
 class="hidden fixed inset-0 bg-black/50 flex justify-center items-center z-50">

  <div class="bg-white w-[360px] rounded-2xl p-6 relative">

    <!-- CLOSE -->
    <button onclick="closeNoDueModal()"
      class="absolute top-3 right-4 text-xl font-bold">âœ–</button>

    <h2 class="text-center text-lg font-bold mb-6">
      No Due Status
    </h2>

    <div id="noDueContent" class="space-y-4">

      <!-- rows inserted by JS -->

    </div>
  </div>
</div>

{{ students|json_script:"students-data" }}

<script>
  const STUDENTS = JSON.parse(
    document.getElementById("students-data").textContent
  );

  const STUDENTS_NO_DUE = {};
  STUDENTS.forEach(s => {
    STUDENTS_NO_DUE[s.id] = s.no_dues || {};
  });
</script>
<script>

  window.addEventListener("load", () => {

  const errorMsg = document.getElementById("addErrorMsg");
  const successMsg = document.getElementById("addSuccessMsg");

  if (errorMsg) {
    setTimeout(() => {
      errorMsg.style.display = "none";
    }, 3000); // â±ï¸ 3 seconds
  }

  if (successMsg) {
    setTimeout(() => {
      successMsg.style.display = "none";
    }, 3000); // â±ï¸ 3 seconds
  }

});


function openAddModal(){addModal.classList.remove("hidden")}
function closeAddModal(){addModal.classList.add("hidden")}
function openEditModal(id,r,rg,n,d,p,sem,y){
  edit_sem.value=sem; edit_year.value=y;
  edit_id.value=id;edit_roll.value=r;edit_reg.value=rg;
  edit_name.value=n;edit_dob.value=d;edit_phone.value=p;

  editModal.classList.remove("hidden");
}
function closeEditModal(){editModal.classList.add("hidden")}
function handleDeleteClick() {
  const checkboxes = document.querySelectorAll(
    "input[name='student_ids']:checked"
  );

  const error = document.getElementById("deleteError");

  if (checkboxes.length === 0) {
    error.classList.remove("hidden");

    // ðŸ”¥ auto hide after 3 seconds
    setTimeout(() => {
      error.classList.add("hidden");
    }, 3000);

    return;
  }

  error.classList.add("hidden");
  deleteModal.classList.remove("hidden");
}

function closeDeleteConfirm(){deleteModal.classList.add("hidden")}
function submitDelete(){ document.getElementById("deleteForm").submit();}



window.addEventListener("load", () => {
  const list = document.getElementById("studentList");
  if (!list) return;

  const cards = Array.from(list.getElementsByClassName("student-card"));

  cards.sort((a, b) => {
    const regA = a.dataset.reg.trim();
    const regB = b.dataset.reg.trim();
    return regA.localeCompare(regB, undefined, { numeric: true });
  });

  cards.forEach(card => list.appendChild(card));
});




function openNoDueModal(studentId) {
  const modal = document.getElementById("noDueModal");
  const content = document.getElementById("noDueContent");

  content.innerHTML = "";

  const offices = ["LIBRARY", "HOSTEL", "COLLEGE", "DEPARTMENT"];
  const noDues = STUDENTS_NO_DUE[studentId] || {};

  offices.forEach(office => {
    const status = noDues[office] || "NOT_SENT";

    let displayStatus = status;
    let color = "text-gray-600";

    if (status === "NOT_SENT") {
      displayStatus = "Incomplete";
      color = "text-red-600";
    }
    else if (status === "APPROVED") {
      displayStatus = "Completed";
      color = "text-green-600";
    }
    else if (status === "PENDING") {
      displayStatus = "Pending";
      color = "text-yellow-600";
    }
    else if (status === "REJECTED") {
      displayStatus = "Rejected";
      color = "text-red-600";
    }

    content.innerHTML += `
      <div class="flex justify-between items-center border-b pb-2">
        <span class="font-semibold">${office} Office</span>
        <span class="${color} font-semibold">${displayStatus}</span>
      </div>
    `;
  });

  modal.classList.remove("hidden");
}

function closeNoDueModal() {
  document.getElementById("noDueModal").classList.add("hidden");
}
</script>

{% endblock %}

