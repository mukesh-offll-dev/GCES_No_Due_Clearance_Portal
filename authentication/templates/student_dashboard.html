{% extends "base.html" %}
{% block title %}Student Dashboard{% endblock %}

{% block content %}

<main class="max-w-6xl mx-auto px-6 py-10">

  <!-- STUDENT DETAILS -->
  <section class="border-2 border-[#d52b1e] rounded-[40px] px-10 py-8 mb-8">
    <h1 class="text-[#d52b1e] font-extrabold text-2xl mb-6">
      Student Details
    </h1>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-y-3 gap-x-16 text-gray-900">

      <p>
        <span class="font-semibold">Name :</span>
        <span class="ml-2 tracking-wide">{{ student.name }}</span>
      </p>

      <p>
        <span class="font-semibold">Year :</span>
        <span class="ml-2">{{ student.year }}</span>
      </p>
      <p>
        <span class="font-semibold">Semester :</span>
        <span class="ml-2">{{ student.semester }}</span>
      </p>

      <p>
        <span class="font-semibold">Register Number :</span>
        <span class="ml-2">{{ student.reg_no }}</span>
      </p>

      <p>
        <span class="font-semibold">Branch :</span>
        <span class="ml-2">{{ student.branch }}</span>
      </p>

      <p>
        <span class="font-semibold">Date of Birth :</span>
        <span class="ml-2">{{ student.dob }}</span>
      </p>

      <p>
        <span class="font-semibold">Roll no :</span>
        <span class="ml-2">{{ student.roll_no }}</span>
      </p>

      <p class="md:col-span-2">
        <span class="font-semibold">Phone Number :</span>
        <span class="ml-2">{{ student.phone }}</span>
      </p>

    </div>
    <button onclick="openEditProfileModal()"
            class="ml-auto bg-blue-600 text-white px-4 py-1.5 rounded-full text-sm font-semibold mt-2 ">
      Edit
    </button>

  </section>


<!-- NO DUES CARD -->
<div class="border-2 border-[#d52b1e] rounded-2xl overflow-hidden max-w-xl mx-auto">

  <!-- HEADER -->
  <div class="text-center text-xl font-bold text-[#d52b1e] py-4 border-b-2 border-[#d52b1e]">
    No Dues
  </div>

  <!-- ROWS -->
  <div class="divide-y-2 divide-[#d52b1e]">

  {% for d in dues %}
    <div class="grid grid-cols-2 items-center px-8 py-6">

      <!-- LEFT : OFFICE -->
      <div class="text-lg font-semibold">
        {{ d.office|title }} Office
      </div>

      <!-- RIGHT : STATUS / BUTTON -->
      <div class="flex justify-end">

      {% if d.status == "PENDING" %}
        <span class="text-yellow-600 font-semibold">
          Pending
        </span>

      {% elif d.status == "APPROVED" %}
        <span class="text-green-600 font-semibold">
          Completed
        </span>

      {% elif d.status == "REJECTED" %}
        <div class="text-right">
          <p class="text-red-600 font-semibold">
            Rejected
          </p>
          <p class="text-sm text-gray-600">
            Reason: {{ d.reject_reason }}
          </p>

          <form method="POST" action="{% url 'retry_request' %}" class="mt-2">
            {% csrf_token %}
            <input type="hidden" name="office" value="{{ d.office }}">
            <button
              class="bg-yellow-500 text-white px-4 py-1.5 rounded-full text-sm font-semibold hover:bg-yellow-600">
              Try Again
            </button>
          </form>
        </div>

      {% elif d.status == "NOT_SENT" %}
        <button type="button"
        data-office="{{ d.office }}"
        onclick="openConfirmModal(this)"
        class="bg-[#d52b1e] text-white px-4 py-1.5 rounded-full font-semibold
               flex items-center justify-center gap-2">
  <span class="btn-text">Send for Verification</span>
</button>



      {% endif %}

      </div>
    </div>
  {% endfor %}

  </div>
</div>


{% if all_approved %}
<div class="text-center mt-8">
  <a href="{% url 'no_due_certificate' %}"
     class="bg-blue-600 text-white px-6 py-2 rounded-full font-semibold">
    Download No Due Certificate
  </a>
</div>
{% endif %}


</main>


<div id="confirmModal"
     class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
  <div class="bg-white border-4 border-[#d52b1e] rounded-2xl p-6 w-[350px] text-center">

    <h3 class="text-lg font-bold mb-4">
      Send request to <span id="officeName"></span> Office?
    </h3>

    <div class="flex justify-center gap-4">
      <button onclick="closeConfirmModal()"
              class="px-6 py-2 rounded-full bg-gray-300">
        Cancel
      </button>

      <button onclick="confirmRequest()"
              class="px-6 py-2 rounded-full bg-[#d52b1e] text-white">
        Yes
      </button>
    </div>
  </div>
</div>







<!-- ================= EDIT PROFILE MODAL ================= -->
<div id="editProfileModal"
     class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">

  <div class="bg-white border-4 border-[#d52b1e] rounded-[30px] p-6 w-[380px] relative">

    <button onclick="closeEditProfileModal()"
            class="absolute top-3 right-4 text-xl font-bold">‚úñ</button>

    <h2 class="text-center text-[#d52b1e] font-bold text-xl mb-4">
      Edit Profile
    </h2>

    <form method="POST" action="{% url 'update_student_profile' %}">
      {% csrf_token %}

      <label class="block font-semibold mb-1">Year</label>
      <select name="year"
              required
              class="w-full border rounded-full px-4 py-2 mb-4">
        <option value="1" {% if student.year == 1 %}selected{% endif %}>1</option>
        <option value="2" {% if student.year == 2 %}selected{% endif %}>2</option>
        <option value="3" {% if student.year == 3 %}selected{% endif %}>3</option>
        <option value="4" {% if student.year == 4 %}selected{% endif %}>4</option>
      </select>

      <label class="block font-semibold mb-1">Semester</label>
      <input type="number"
             name="semester"
             min="1"
             max="8"
             required
             value="{{ student.semester }}"
             class="w-full border rounded-full px-4 py-2 mb-5">

      <button
        class="w-full bg-[#d52b1e] text-white py-2 rounded-full font-semibold">
        Update
      </button>
    </form>
  </div>
</div>






<!-- HOSTEL MODAL -->
<div id="hostelModal"
     class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">

  <div class="bg-white border-4 border-[#d52b1e] rounded-[30px] p-6 w-[400px] relative">

    <!-- Close -->
    <button onclick="closeHostelModal()"
            class="absolute top-3 right-4 text-xl font-bold" id="clbtn">‚úñ</button>

    <h2 class="text-center text-[#d52b1e] font-bold text-xl mb-4">
      Hostel Verification
    </h2>

    <form method="POST"
      action="{% url 'send_hostel' %}"
      enctype="multipart/form-data"
      onsubmit="handleHostelSubmit()">

      {% csrf_token %}

      <label class="block font-semibold mb-1">Last Payment ID</label>
      <input name="payment_id"
             required
             class="w-full border rounded-full px-4 py-2 mb-4" >

      <label class="block font-semibold mb-1">Attach Payment Screenshot</label>
      <input type="file"
             name="receipt"
             accept="image/*"
             required
             class="mb-5">

      <button
        id="hostelSubmitBtn"
        class="w-full bg-[#d52b1e] text-white py-2 rounded-full font-semibold flex justify-center items-center gap-2">
        <span id="hostelBtnText">Send for Verification</span>
      </button>

    </form>
  </div>
</div>

<!-- LOGIN POPUP MESSAGE -->
<div id="loginPopup"
     class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">

  <div class="bg-white border-4 border-[#d52b1e] rounded-2xl p-6 w-[380px] text-center relative">

    <button onclick="closeLoginPopup()"
            class="absolute top-3 right-4 text-xl font-bold">‚úñ</button>

    <h3 class="text-[#d52b1e] font-bold text-lg mb-3">
      Important Notice
    </h3>

    <p class="text-gray-900">
      Student, please check your current Year and Semester correctly
      before sending any No-Due request to the office.
    </p>

    

  </div>
</div>

<script>

  function openLoginPopup() {
  document.getElementById("loginPopup").classList.remove("hidden");

  // Auto close after 7 seconds
  setTimeout(() => {
    closeLoginPopup();
  }, 7000);
}

function closeLoginPopup() {
  document.getElementById("loginPopup").classList.add("hidden");
}

// üî• IMPORTANT ‚Äî Show popup when page loads (student login)
window.onload = function() {
  openLoginPopup();
};


let selectedOffice = null;
let selectedBtn = null;
let sending = false;

function openConfirmModal(btn) {
  selectedBtn = btn;                       // üî• store button
  selectedOffice = btn.dataset.office;

  document.getElementById("officeName").innerText = selectedOffice;
  document.getElementById("confirmModal").classList.remove("hidden");
}

function closeConfirmModal() {
  document.getElementById("confirmModal").classList.add("hidden");
}

function confirmRequest() {
  if (sending) return;
  sending = true;

  closeConfirmModal();

  // ================= HOSTEL =================
  if (selectedOffice === "HOSTEL") {
    document.getElementById("hostelModal").classList.remove("hidden");
    return;
  }

  // ================= OTHER OFFICES =================
  // üîí disable original button
  selectedBtn.disabled = true;
  selectedBtn.classList.add("opacity-70", "cursor-not-allowed");

  // üîÑ spinner
  selectedBtn.innerHTML = `
    <svg class="animate-spin h-5 w-5 text-white"
         viewBox="0 0 24 24">
      <circle cx="12" cy="12" r="10"
        stroke="white"
        stroke-width="4"
        fill="none"
        stroke-dasharray="31.4"
        stroke-linecap="round"/>
    </svg>
    <span>Sending...</span>
  `;

  // üöÄ send request
  fetch("{% url 'send_no_due' %}", {
    method: "POST",
    headers: {
      "X-CSRFToken": "{{ csrf_token }}",
      "Content-Type": "application/x-www-form-urlencoded"
    },
    body: `office=${selectedOffice}`
  }).then(() => location.reload());
}

function closeConfirmModal() {
  document.getElementById("confirmModal").classList.add("hidden");
}
function closeHostelModal() {
  document.getElementById("hostelModal").classList.add("hidden");
}
 


 
function openEditProfileModal() {
  document.getElementById("editProfileModal").classList.remove("hidden");
}

function closeEditProfileModal() {
  document.getElementById("editProfileModal").classList.add("hidden");
}

 
let hostelSubmitting = false;

function handleHostelSubmit() {
  if (hostelSubmitting) {
    return false; // ‚ùå block double submit
  }

  hostelSubmitting = true;

  const btn = document.getElementById("hostelSubmitBtn");
  const text = document.getElementById("hostelBtnText");
  const clbtn = document.getElementById("clbtn");
  clbtn.disabled = true;
  btn.disabled = true;
  btn.classList.add("opacity-70", "cursor-not-allowed");

  text.innerHTML = `
    <svg class="animate-spin h-5 w-5 text-white"
         viewBox="0 0 24 24">
      <circle cx="12" cy="12" r="10"
        stroke="white"
        stroke-width="4"
        fill="none"
        stroke-dasharray="31.4"
        stroke-linecap="round"/>
    </svg>
    <span>Sending...</span>
  `;

  return true; // ‚úÖ allow submit once
}


let otherOfficeSending = false;

function handleOtherOfficeClick(btn) {
  if (otherOfficeSending) return; // ‚ùå block multi click
  otherOfficeSending = true;

  const office = btn.dataset.office;

  // üîí disable button
  btn.disabled = true;
  btn.classList.add("opacity-70", "cursor-not-allowed");

  // üîÑ replace text with spinner
  btn.innerHTML = `
    <svg class="animate-spin h-5 w-5 text-white"
         viewBox="0 0 24 24">
      <circle cx="12" cy="12" r="10"
        stroke="white"
        stroke-width="4"
        fill="none"
        stroke-dasharray="31.4"
        stroke-linecap="round"/>
    </svg>
    <span>Sending...</span>
  `;

  // üöÄ send request
  fetch("{% url 'send_no_due' %}", {
    method: "POST",
    headers: {
      "X-CSRFToken": "{{ csrf_token }}",
      "Content-Type": "application/x-www-form-urlencoded"
    },
    body: `office=${office}`
  }).then(() => location.reload());
}
 
</script>


{% endblock %}
