{% extends "base.html" %}
{% block title %}Hostel Office{% endblock %}

{% block content %}

<main class="max-w-6xl mx-auto px-6 py-6">

  <!-- PAGE TITLE -->
  <div class="flex justify-center mt-4 mb-6">
    <div class="bg-[#d52b1e] text-white font-semibold text-xl px-16 py-3 rounded-full">
      Hostel Office
    </div>
  </div>

  <!-- FILTER CARD -->
  <form method="GET"
        class="border-2 border-[#d52b1e] rounded-[40px] px-8 py-6 mb-6">

    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 items-center">

      <!-- Branch -->
      <div>
        <label class="font-semibold mb-2 block">Branch</label>
       <select name="branch"
        onchange="this.form.submit()"
        class="w-full border rounded-full px-4 py-2">
  <option value="">Select Branch</option>
  {% for b in branches %}
    <option value="{{ b }}" {% if branch == b %}selected{% endif %}>
      {{ b }}
    </option>
  {% endfor %}
</select>

      </div>

      <!-- Year -->
      <div>
        <label class="font-semibold mb-2 block">Year</label>
       <select name="year"
        onchange="this.form.submit()"
        class="w-full border rounded-full px-4 py-2">
        <option value="">Select Year</option>
        <option value="1" {% if year == "1" %}selected{% endif %}>1</option>
        <option value="2" {% if year == "2" %}selected{% endif %}>2</option>
        <option value="3" {% if year == "3" %}selected{% endif %}>3</option>
        <option value="4" {% if year == "4" %}selected{% endif %}>4</option>
        </select>

      </div>

      <div class="flex flex-wrap justify-center gap-2">

      {% if not branch and not year %}
      <div class="flex flex-wrap justify-end gap-3 mb-6">
        {% for b, c in branch_summary.items %}
          <span class="bg-[#d52b1e] text-white px-5 py-2 rounded-full font-semibold">
            {{ b }} - {{ c }}
          </span>
        {% endfor %}
      </div>
      {% endif %}

      {% if branch and not year %}
      <div class="flex flex-wrap justify-end gap-3 mb-6">
        {% for y, c in year_summary.items %}
          <a href="?branch={{ branch }}&year={{ y }}"
            class="bg-[#d52b1e] text-white px-5 py-2 rounded-full font-semibold hover:scale-105 transition">
            {{ y }} Year - {{ c }}
          </a>
        {% endfor %}
      </div>
      {% endif %}

      {% if branch and year %}
      <div class="flex justify-end mb-6">
        <span class="bg-[#d52b1e] text-white px-6 py-2 rounded-full font-semibold">
          Students Count - {{ count }}
        </span>
      </div>
      {% endif %}

      
    </div>

    </div>
  </form>

  <!-- REQUEST LIST -->
  <section class="border-2 border-[#d52b1e] rounded-[40px] px-6 py-6">

    {% if branch and year %}

      {% for r in requests %}
      <div class="border rounded-[20px] p-5 mb-4 flex flex-col md:flex-row md:items-center md:justify-between gap-4">

        <!-- DETAILS -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 text-sm font-medium">

          <div>
            <p class="font-semibold">Reg no</p>
            <p class="text-gray-700">{{ r.student.reg_no }}</p>
          </div>

          <div>
            <p class="font-semibold">Name</p>
            <p class="text-gray-700">{{ r.student.name }}</p>
          </div>

          <div>
            <p class="font-semibold">Last Payment ID</p>
            <p class="text-gray-700">{{ r.last_payment_id }}</p>
          </div>

          {% if r.receipt %}
  <div class="flex flex-col gap-1 text-right">
    <span class="text-sm font-semibold ">
      View Receipt
    </span>
    <a href="{{ MEDIA_URL }}{{ r.receipt }}"
       target="_blank"
       class="text-blue-600 underline font-semibold hover:text-blue-800">
      View Receipt
    </a>
  </div>
{% else %}
  <span class="text-gray-400 text-sm">No Receipt</span>
{% endif %}



        </div>

        <!-- ACTIONS -->
        <div class="flex gap-4">

          <!-- APPROVE -->
          <form method="POST" action="{% url 'bulk_approve' %}">
            {% csrf_token %}
            <input type="hidden" name="request_ids" value="{{ r.id }}">
            <button
              class="bg-green-600 text-white px-6 py-2 rounded-full font-semibold">
              Verify & Approve
            </button>
          </form>

          <!-- REJECT -->
          <button onclick="openReject('{{ r.id }}')"
            class="bg-[#d52b1e] text-white px-6 py-2 rounded-full font-semibold">
            Reject
          </button>

        </div>

      </div>
      {% empty %}
        <p class="text-center font-semibold text-gray-600 mt-6">
          No pending requests
        </p>
      {% endfor %}

    {% else %}
      <p class="text-center font-semibold text-gray-600">
        Please select Branch and Year
      </p>
    {% endif %}

  </section>

</main>

<!-- ================= REJECT MODAL ================= -->
<div id="rejectModal"
     class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">

  <form method="POST" action="{% url 'reject_request' %}"
        class="bg-white border-4 border-[#d52b1e] rounded-[30px] p-6 w-[380px]">

    {% csrf_token %}
    <input type="hidden" name="req_id" id="rejectReqId">

    <h3 class="text-center font-bold text-lg mb-4">
      Enter the reason to reject
    </h3>

    <textarea name="reason"
              required
              class="w-full border rounded-xl p-3 mb-4"
              rows="3"></textarea>

    <button class="bg-[#d52b1e] text-white w-full py-2 rounded-full font-semibold">
      Submit
    </button>

    <button type="button"
            onclick="closeReject()"
            class="w-full mt-2 text-center">
      Cancel
    </button>

  </form>
</div>

<script>
function openReject(id){
  document.getElementById("rejectReqId").value = id;
  document.getElementById("rejectModal").classList.remove("hidden");
}
function closeReject(){
  document.getElementById("rejectModal").classList.add("hidden");
}
</script>

{% endblock %}
